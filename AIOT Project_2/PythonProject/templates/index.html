<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—ë„ˆì§€ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js" crossorigin="anonymous"></script>
</head>
<body>
    <!-- 1. ì¶”ì „ì§€ ì”ì—¬ëŸ‰ í‘œì‹œ -->
    <div class="box">
        <h2>1. ESS ì „ë ¥ ì”ì—¬ëŸ‰</h2>
        <p>(ì „ë ¥ì¸¡ì •ì¥ì¹˜ì™€ ì—°ë™)</p>
        <p id="peak_risk">ë¡œë”© ì¤‘...</p>
    </div>

    <!-- 2. í˜„ì¬ ì „ë ¥ì› í‘œì‹œ -->
    <div class="box">
        <h2>2. í˜„ì¬ ì „ë ¥ì›</h2>
        <p>(íƒœì–‘ê´‘ or ì¼ë°˜ì „ë ¥ ì—¬ë¶€)</p>
        <p id="power_source">ë¡œë”© ì¤‘...</p>
    </div>

    <!-- 3. íƒœì–‘ê´‘ ì „í™˜ ì´ë ¥ -->
    <div class="box">
        <h2>3. íƒœì–‘ê´‘ ì „í™˜ ì´ë ¥</h2>
        <p>(ëª‡ ì‹œì— ì „í™˜ë˜ì—ˆëŠ”ì§€ ë¡œê·¸ í‘œì‹œ)</p>
        <ul id="switch_log">
            <li>ë¡œë”© ì¤‘...</li>
        </ul>
    </div>

    <!-- 4. ë‚ ì§œ ì„ íƒ ë° ì˜ˆì¸¡ ê²°ê³¼ í‘œì‹œ -->
    <div class="box">
        <h2>4. í”¼í¬ ì˜ˆì¸¡ ê²°ê³¼</h2>
        <p>(ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ë‚ ì§œì˜ ì‹œê°„ë³„ ì˜ˆì¸¡ ê²°ê³¼ê°€ í‘œì‹œë¨)</p>
        <input type="date" id="datePicker">
        <ul id="prediction_result">
            <li>ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</li>
        </ul>
    </div>

    <!-- 5. LED ì „í™˜ ìƒíƒœ -->
    <div class="box">
        <h2>5. ì˜ˆì¸¡ ê¸°ë°˜ LED ìƒíƒœ</h2>
        <p id="led_status" style="font-weight: bold; font-size: 18px; color: gray;">ì„ íƒëœ ë‚ ì§œ ì—†ìŒ</p>
    </div>

    <script>
        const socket = io();
        socket.on('connect', () => console.log("ì„œë²„ì— ì—°ê²°ë¨"));
        socket.on('realtime_data', (data) => {
            document.getElementById("power_source").innerText = data.source === 'solar' ? "íƒœì–‘ê´‘" : "ì¼ë°˜ ì „ë ¥";
            const logElement = document.getElementById("switch_log");
            const newLog = document.createElement("li");
            newLog.innerText = `íƒœì–‘ê´‘ìœ¼ë¡œ ì „í™˜ë¨! ì‹œê°„: ${data.time}`;
            logElement.prepend(newLog);
        });

        function loadPeakRisk() {
            fetch('/api/predicted_peak')
                    .then(res => res.json())
                    .then(data => {
                        const peak = data.peak_risk_index.toFixed(2);
                        const isPeak = data.is_predicted_peak ? 'âš ï¸ ìœ„í—˜' : 'ì •ìƒ';
                        document.getElementById('peak_risk').innerText = `${peak} (${isPeak})`;
                    }).catch(err => {
                document.getElementById('peak_risk').innerText = 'ë°ì´í„° ë¡œë”© ì‹¤íŒ¨';
                console.error(err);
            });
        }

        function loadPredictionForDate(date) {
            if (!date) return;

            document.getElementById("datePicker").value = date;

            Promise.all([
                fetch(`/api/ml_predict?date=${date}`).then(async res => {
                    if (!res.ok) throw new Error(await res.text());
                    return res.json();
                }),
                fetch(`/api/kma_full_weather?date=${date}`).then(async res => {
                    if (!res.ok) throw new Error(await res.text());
                    return res.json();
                })
            ]).then(([mlData, weatherData]) => {
                const list = document.getElementById("prediction_result");
                list.innerHTML = "";

                if (mlData.error) {
                    list.innerHTML = `<li>âŒ ì„œë²„ ì˜¤ë¥˜ (ML): ${mlData.error}</li>`;
                    return;
                }
                if (weatherData.error) {
                    const li = document.createElement("li");
                    li.innerText = `âŒ ì„œë²„ ì˜¤ë¥˜ (ë‚ ì”¨): ${weatherData.error}`;
                    list.appendChild(li);
                }

                const weatherMap = {};
                (weatherData.weather || []).forEach(w => {
                    const hour = w.time;
                    weatherMap[hour] = w;
                });

                mlData.results.forEach(item => {
                    const weather = weatherMap[item.time] || {};
                    const li = document.createElement("li");

                    const temp = weather.temperature ? `ğŸŒ¡ ${weather.temperature}â„ƒ` : '';
                    const humid = weather.humidity ? `ğŸ’§ ${weather.humidity}%` : '';
                    const sun = weather.sunshine ? `â˜€ï¸ ${weather.sunshine}h` : '';

                    li.innerHTML = `${item.time} - ì˜ˆì¸¡: ${item.predicted}â‚©, ì‹¤ì œ: ${item.actual}â‚© ${temp} ${humid} ${sun}` +
                            (item.note ? ` <span class="spike-label">${item.note}</span>` : '');
                    list.appendChild(li);
                });

                const r2 = document.createElement("li");
                r2.innerText = `ğŸ“ˆ ì„¤ëª…ë ¥ (RÂ²): ${mlData.r2}`;
                list.appendChild(r2);

                const ledText = document.getElementById("led_status");
                if (mlData.led_signal === "danger_on") {
                    ledText.innerText = "ğŸ”´ ìœ„í—˜ (DANGER)";
                    ledText.style.color = "red";
                } else if (mlData.led_signal === "warning_on") {
                    ledText.innerText = "ğŸŸ  ê²½ê³  (WARNING)";
                    ledText.style.color = "orange";
                } else if (mlData.led_signal === "safe_on") {
                    ledText.innerText = "ğŸŸ¢ ì•ˆì „ (SAFE)";
                    ledText.style.color = "green";
                } else {
                    ledText.innerText = "LED ìƒíƒœ ì•Œ ìˆ˜ ì—†ìŒ";
                    ledText.style.color = "gray";
                }
            }).catch(err => {
                const list = document.getElementById("prediction_result");
                list.innerHTML = `<li>âŒ ì˜ˆì¸¡ fetch ì‹¤íŒ¨: ${err.message}</li>`;
                console.error(err);
            });
        }

        // âœ… ë‚ ì§œ ì„ íƒ ì‹œ ìˆ˜ë™ ê°±ì‹ 
        document.getElementById("datePicker").addEventListener("change", () => {
            const date = document.getElementById("datePicker").value;
            loadPredictionForDate(date);
        });

        // âœ… í˜ì´ì§€ ë¡œë”© ì‹œ ìë™ ë‚ ì§œ ì˜ˆì¸¡ ì‹œì‘
        window.addEventListener('DOMContentLoaded', () => {
            loadPeakRisk();

            let currentDate = new Date("2024-01-21");

            function nextDay() {
                const dateStr = currentDate.toISOString().split("T")[0];
                loadPredictionForDate(dateStr);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            nextDay(); // ìµœì´ˆ ì‹¤í–‰
            setInterval(nextDay, 5000); // 5ì´ˆë§ˆë‹¤ ê°±ì‹ 
        });
    </script>


</body>
</html>
